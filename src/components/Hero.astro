---
import { baseUrl } from '@/utils/functions';
import Camera from './Camera.astro';
---

<Camera />

<div class='hub__wrapper'>
  <div id='miniMap' class='position-fixed mini-map'>
    <div id='mapMarker' class='position-absolute mini-map-marker'></div>
  </div>

  <div class='hub__container'>
    <div class='hub hub-day'>
      <div class='hub__inner-wrapper'>
        <img
          id='light__off'
          src={baseUrl('/assets/image-1.avif')}
        />
      </div>
    </div>
  </div>
</div>

<script>
  import gsap from 'gsap';
  import { Draggable } from 'gsap/Draggable';

  gsap.registerPlugin(Draggable);

  const bigImage = document.querySelector<HTMLElement>('.hub');
  const smallImage = document.querySelector<HTMLElement>('#miniMap');
  const marker = document.querySelector<HTMLElement>('#mapMarker');

  if (!bigImage || !smallImage || !marker) throw new Error('Elementos faltantes');

  const smallX = gsap.quickSetter(marker, 'x', 'px');
  const smallY = gsap.quickSetter(marker, 'y', 'px');
  const bigX = gsap.quickSetter(bigImage, 'x', 'px');
  const bigY = gsap.quickSetter(bigImage, 'y', 'px');

  let imageScale = 1;

  function setupSizing() {
    imageScale = smallImage.offsetWidth / bigImage.offsetWidth;
    const screenToBigRatio = window.innerWidth / bigImage.offsetWidth;
    const aspectRatio = window.innerWidth / window.innerHeight;
    gsap.set(marker, {
      width: screenToBigRatio * smallImage.offsetWidth,
      height: (screenToBigRatio * smallImage.offsetWidth) / aspectRatio
    });
  }

  setupSizing();
  window.addEventListener('resize', setupSizing);

  const bigDraggable = Draggable.create(bigImage, {
    bounds: window,
    onDrag: alignSmall,
    onThrowUpdate: alignSmall,
    inertia: true
  })[0];

  function alignSmall() {
    smallX(-bigDraggable.x * imageScale);
    smallY(-bigDraggable.y * imageScale);
  }

  const smallDraggable = Draggable.create(marker, {
    bounds: smallImage,
    onDrag: alignBig,
    onThrowUpdate: alignBig,
    inertia: true
  })[0];

  function alignBig() {
    bigX(-smallDraggable.x / imageScale);
    bigY(-smallDraggable.y / imageScale);
  }

  gsap.set(bigImage, {
    x: (bigDraggable.minX + bigDraggable.maxX) / 2,
    y: (bigDraggable.minY + bigDraggable.maxY) / 2
  });

  bigDraggable.update();
  alignSmall();
</script>
